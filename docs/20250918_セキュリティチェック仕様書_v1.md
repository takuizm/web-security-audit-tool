# セキュリティチェック仕様書

**文書番号**: 20250918_セキュリティチェック仕様書_v1
**作成日**: 2025年9月18日
**版数**: v1.0

## 1. 概要

### 1.1 目的
本文書は、Webセキュリティ診断自動化ツールが実行するセキュリティチェックの技術的仕様と実装方法を詳述します。

### 1.2 診断項目概要
本ツールは以下の8つのセキュリティ項目について自動診断を実行します：

1. コンポーネント脆弱性診断（S1-1, S1-2）
2. 暗号化通信診断（S2）
3. TLSセキュリティ診断（S3, S4）
4. アクセス制御診断（S6-1, S6-2, S6-3, S7）
5. セキュリティヘッダー診断（S8-1, S8-2, S8-3）

## 2. 診断項目詳細仕様

### 2.1 コンポーネント脆弱性診断

#### 2.1.1 S1-1: jQuery 3.5.0以上チェック（未使用は「未」）

**目的**: Webサイトで使用されているjQueryライブラリのバージョンが安全かどうかを確認

**実装方法**:
1. **Selenium WebDriver**を使用してWebページを読み込み
2. JavaScript実行により以下のコードでjQueryバージョンを取得:
   ```javascript
   if (typeof $ !== 'undefined' && $.fn && $.fn.jquery) {
       return $.fn.jquery;
   } else if (typeof jQuery !== 'undefined' && jQuery.fn && jQuery.fn.jquery) {
       return jQuery.fn.jquery;
   } else {
       return null;
   }
   ```
3. バージョン比較ロジック:
   - バージョン3.5.0以上: 「1」（合格）
   - バージョン3.5.0未満: 「0」（不合格）
   - jQuery未使用: 「未」

**判定基準**:
- 脆弱性が報告されているjQueryバージョンリスト（1.0～2.2系）との照合
- セマンティックバージョニングによる数値比較

**技術的詳細**:
- タイムアウト: 30秒
- ブラウザ設定: ヘッドレスモード、JavaScript有効
- エラーハンドリング: ページ読み込み失敗時はERROR判定

#### 2.1.2 S1-2: jQuery 3.5.0以上チェック（未使用は0）

**目的**: S1-1と同じjQuery診断だが、未使用時の評価が異なる

**実装方法**: S1-1と同一の技術的実装

**判定基準**:
- バージョン3.5.0以上: 「1」（合格）
- バージョン3.5.0未満: 「0」（不合格）
- jQuery未使用: 「0」（不合格）

### 2.2 暗号化通信診断

#### 2.2.1 S2: 非暗号化通信接続が許可されていない

**目的**: WebサイトがHTTP接続を適切に制限し、HTTPS通信を強制しているかを確認

**実装方法**:
1. **HTTPアクセステスト**:
   - 対象URLのHTTPS部分をHTTPに変更
   - `allow_redirects=False`でHTTPリクエストを送信
   - レスポンスコードとLocationヘッダーを確認

2. **HTTPSリダイレクトテスト**:
   - `allow_redirects=True`でHTTPリクエストを送信
   - 最終的なURLがHTTPSかどうかを確認

3. **404ページリダイレクトテスト**:
   - 存在しないパス（`/nonexistent-test-path-12345`）にHTTPアクセス
   - 適切に404またはHTTPSリダイレクトされるかを確認

**判定基準**:
- HTTPアクセスがブロック（4xx, 5xxエラー）: 「1」（合格）
- HTTPアクセスがHTTPSにリダイレクト（301, 302等）: 「1」（合格）
- HTTPアクセスで正常レスポンス（200等）: 「0」（不合格）

**技術的詳細**:
- リクエストヘッダー: `User-Agent: SecurityAuditTool/1.0`
- タイムアウト: 30秒
- リトライ: 最大3回

### 2.3 TLSセキュリティ診断

#### 2.3.1 S3: TLS1.3が有効

**目的**: 最新のTLS1.3プロトコルがサポートされているかを確認

**実装方法**:
1. **SSL/TLS接続テスト**:
   ```python
   context = ssl.create_default_context()
   context.minimum_version = ssl.TLSVersion.TLSv1_3
   context.maximum_version = ssl.TLSVersion.TLSv1_3
   ```
2. 指定されたTLSバージョンでのハンドシェイク試行
3. 成功時は暗号スイートと実際のTLSバージョンを記録

**判定基準**:
- TLS1.3での接続成功: 「1」（合格）
- TLS1.3での接続失敗: 「0」（不合格）

**出力詳細**:
- 合格時: 実際のTLSバージョン（例: "TLSv1.3"）
- 不合格時: "TLS1.3未サポート"

#### 2.3.2 S4: TLS1.1以前が無効

**目的**: セキュリティリスクのある古いTLSバージョンが無効化されているかを確認

**実装方法**:
1. **TLS1.1接続テスト**:
   - 厳密なバージョン指定での接続試行
   - 失敗時はレガシー互換性チェックも実行
2. **TLS1.0接続テスト**:
   - 同様の二段階テスト実行

**判定基準**:
- TLS1.0とTLS1.1の両方が無効: 「1」（合格）
- いずれかが有効: 「0」（不合格）

**技術的詳細**:
- 第一段階: 厳密なバージョン指定
- 第二段階: より緩い設定での互換性チェック
- 証明書検証: 一時的に無効化してプロトコル確認

### 2.4 アクセス制御診断

#### 2.4.1 S6-1: "index of"（公開不要コンテンツno-index制御）

**目的**: ディレクトリリスティングや機密情報が検索エンジンにインデックスされていないかを確認

**実装方法**:
1. **robots.txt解析**:
   - `/robots.txt`ファイルを取得
   - `Disallow:`エントリから機密パスを抽出
   - 'admin', 'private', 'config', 'backup'等の検出

2. **機密ファイル直接チェック**:
   - よくある機密ファイルへの直接アクセス試行
   - `/.env`, `/config.php`, `/wp-config.php`, `/database.sql`, `/backup.zip`, `/.git/config`

3. **ディレクトリリスティング検出**:
   - Apacheの"Index of"ページ
   - Nginxのディレクトリリスティング
   - 自動生成インデックスページ

**判定基準**:
- "index of"関連の露出なし: 「1」（合格）
- "index of"関連の露出あり: 「0」（不合格）

#### 2.4.2 S6-2: "login"（公開不要コンテンツno-index制御）

**目的**: ログインページや認証機能が適切に保護されているかを確認

**実装方法**:
1. **危険パス直接アクセス**:
   - `/login`, `/admin`, `/administrator`, `/wp-admin`等への直接アクセス
   - HTTPステータスコードによる判定

2. **robots.txt内のlogin関連パス**:
   - robots.txtでのlogin関連パス露出確認

**判定基準**:
- ログインページアクセス不可 かつ robots.txt露出なし: 「1」（合格）
- ログインページアクセス可能 または robots.txt露出あり: 「0」（不合格）

#### 2.4.3 S6-3: "password"（公開不要コンテンツno-index制御）

**目的**: パスワードや認証情報を含むファイルが公開されていないかを確認

**実装方法**:
1. **password関連ファイル検出**:
   - `.env`（環境変数ファイル）
   - `config.php`（設定ファイル）
   - `wp-config.php`（WordPress設定）
   - `database.sql`（データベースダンプ）
   - `backup.zip`（バックアップファイル）

2. **robots.txt内のpassword関連パス確認**

**判定基準**:
- password関連ファイル検出なし: 「1」（合格）
- password関連ファイル検出あり: 「0」（不合格）

#### 2.4.4 S7: 公開不要サーバーアクセス制御

**目的**: IPアドレス直接アクセスやテスト用サブドメインが適切に制限されているかを確認

**実装方法**:
1. **IPアドレス直接アクセステスト**:
   ```python
   ip_address = socket.gethostbyname(domain)
   test_url = f"https://{ip_address}"
   response = self.safe_request('GET', test_url)
   ```

2. **サブドメインアクセステスト**:
   - テスト用サブドメイン（test, dev, staging, admin, api, www2）への接続試行

3. **危険パステスト**:
   - `/admin`, `/administrator`, `/login`, `/phpmyadmin`, `/config`, `/backup`, `/test`, `/dev`, `/staging`

**判定基準**:
- IPアクセスブロック かつ サブドメイン安全 かつ 危険パスブロック: 「1」（合格）
- いずれかに問題: 「0」（不合格）

### 2.5 セキュリティヘッダー診断

#### 2.5.1 S8-1: X-Frame-Options

**目的**: クリックジャッキング攻撃を防ぐセキュリティヘッダーの設定確認

**実装方法**:
1. **HTTPレスポンスヘッダー取得**:
   ```python
   response = self.http_client.get(url)
   headers = response.headers
   ```

2. **X-Frame-Optionsヘッダー確認**:
   - ヘッダーの存在確認
   - 有効な値（`DENY`, `SAMEORIGIN`）の確認

**判定基準**:
- X-Frame-Optionsヘッダー設定済み: 「1」（合格）
- X-Frame-Optionsヘッダー未設定: 「0」（不合格）

#### 2.5.2 S8-2: Strict-Transport-Security

**目的**: HTTPS接続を強制するHSTSヘッダーの設定確認

**実装方法**:
1. **HSTSヘッダー確認**:
   - `Strict-Transport-Security`ヘッダーの存在確認
   - `max-age`値の確認
   - `includeSubDomains`, `preload`オプションの確認

2. **設定値検証**:
   ```python
   max_age_match = re.search(r'max-age=(\d+)', hsts_value)
   recommended_min_age = 31536000  # 1年
   ```

**判定基準**:
- Strict-Transport-Securityヘッダー設定済み: 「1」（合格）
- Strict-Transport-Securityヘッダー未設定: 「0」（不合格）

#### 2.5.3 S8-3: Content-Security-Policy

**目的**: XSS攻撃等を防ぐCSPヘッダーの設定確認

**実装方法**:
1. **CSPヘッダー確認**:
   - `Content-Security-Policy`ヘッダーの存在確認
   - 基本ディレクティブ（`default-src`, `script-src`, `style-src`）の確認

2. **危険な設定検出**:
   - `'unsafe-inline'`の使用確認
   - `'unsafe-eval'`の使用確認
   - ワイルドカード（`*`）の過度な使用確認

**判定基準**:
- Content-Security-Policyヘッダー設定済み: 「1」（合格）
- Content-Security-Policyヘッダー未設定: 「0」（不合格）

## 3. 技術的実装詳細

### 3.1 HTTP通信仕様

#### 3.1.1 基本設定
- **User-Agent**: `SecurityAuditTool/1.0`
- **タイムアウト**: 30秒
- **リトライ**: 最大3回
- **レート制限**: 外部API使用時は各サービスの制限に準拠

#### 3.1.2 SSL/TLS接続設定
```python
# 基本設定
context = ssl.create_default_context()

# 厳密なバージョンチェック用
context.minimum_version = ssl.TLSVersion.TLSv1_3
context.maximum_version = ssl.TLSVersion.TLSv1_3

# レガシー互換性チェック用
context.check_hostname = False
context.verify_mode = ssl.CERT_NONE
context.set_ciphers('ALL:@SECLEVEL=0')
```

### 3.2 ブラウザ自動化仕様

#### 3.2.1 Chrome設定
```python
chrome_options = Options()
chrome_options.add_argument('--headless')
chrome_options.add_argument('--no-sandbox')
chrome_options.add_argument('--disable-dev-shm-usage')
chrome_options.add_argument('--disable-gpu')
chrome_options.add_argument('--window-size=1920,1080')
chrome_options.add_argument('--disable-extensions')
chrome_options.add_argument('--disable-plugins')
```

#### 3.2.2 ページ読み込み待機
```python
WebDriverWait(driver, 10).until(
    lambda d: d.execute_script("return document.readyState") == "complete"
)
```

### 3.3 エラーハンドリング仕様

#### 3.3.1 ネットワークエラー
- **接続タイムアウト**: 30秒後にタイムアウト
- **DNS解決失敗**: ドメイン名解決不可時
- **SSL証明書エラー**: 証明書検証失敗時

#### 3.3.2 診断結果ステータス
- **OK**: 診断成功、セキュリティ要件満たす
- **NG**: 診断成功、セキュリティ要件満たさない
- **WARNING**: 診断成功、軽微な問題あり
- **ERROR**: 診断失敗、技術的問題により判定不可

### 3.4 外部サービス連携仕様

**注意**: 現在の実装では外部APIは使用せず、すべて独自実装で診断を実行しています。

#### 3.4.1 外部API未使用の理由
- **依存性排除**: 外部サービス障害の影響を回避
- **コスト削減**: API利用料金の発生を回避
- **プライバシー保護**: 診断対象URLの外部送信を回避
- **安定性向上**: ネットワーク依存を最小化

#### 3.4.2 独自実装による診断手法
- **TLS診断**: PythonのSSLライブラリによる直接接続
- **セキュリティヘッダー**: HTTPレスポンスヘッダーの直接解析
- **アクセス制御**: robots.txtと直接ファイルアクセスによる確認
- **コンポーネント診断**: Selenium WebDriverによるJavaScript実行

## 4. 診断精度と制限事項

### 4.1 診断精度

#### 4.1.1 高精度項目
- **jQuery バージョン検出**: 98%以上
- **TLS設定確認**: 95%以上
- **セキュリティヘッダー確認**: 99%以上

#### 4.1.2 中精度項目
- **アクセス制御確認**: 80-90%
- **暗号化通信確認**: 90-95%

### 4.2 制限事項

#### 4.2.1 技術的制限
- **JavaScript無効サイト**: 一部機能で診断制限
- **認証が必要なサイト**: ログイン後のページは診断不可
- **地域制限**: 特定地域からのアクセス制限サイト

#### 4.2.2 外部依存制限
- **外部API障害**: 外部サービス障害時は該当機能が制限
- **レート制限**: API制限により診断速度が制限される場合
- **ネットワーク環境**: プロキシ環境等での制限

### 4.3 偽陽性・偽陰性

#### 4.3.1 偽陽性（実際は問題ないが問題ありと判定）
- **CDN使用サイト**: CloudFront等のCDNにより異なる応答
- **ロードバランサー**: 複数サーバー環境での不一致
- **地域別設定**: 接続元地域による設定差異

#### 4.3.2 偽陰性（実際は問題があるが問題なしと判定）
- **動的生成コンテンツ**: JavaScriptで動的生成される脆弱性
- **認証後の脆弱性**: ログイン後にのみ表示される問題
- **タイミング依存**: 時間帯による設定変更
